
#include "DelayControl.h"
#include "comm.h"
#include <string>
#include "Data_m.h"


using std::string;
namespace test {

Define_Module(DelayControl);

void DelayControl::initialize()
{
lastTime = simTime();
ln = 1;
lq = 0;
state = hstate = 0;
}

void DelayControl::handleMessage(cMessage *msg)
{
    if(msg->isSelfMessage()){//send package directly
        EV<<"SELF MESSAGE\n";
        if(n.length()!=0)
        {
            send(n.pop(),"send");
        }else
        send(d.pop(),"send");
        }
    else{
            Data *pk = check_and_cast<Data *>(msg);
            if(pk->getType()==0){//this is normal data
                d.insert(pk);
            }
            else n.insert(pk);
            cMessage *notice = new cMessage("notice");
            int lq = n.length()+d.length();
            if(lq ==0){
                state = 1;
            }
            else
                state = lq/ln + 0.8*hstate;
            double t = dblrand()*10;
            scheduleAt(lastTime+t,notice);
            lastTime = lastTime +t;
            EV <<pk->getState()<<"this is status of sensor \n";
        }
    EV <<simTime()<<"  CORRECT \n";


}




}; // namespace
